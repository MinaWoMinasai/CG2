name: CheckUnwantedFiles

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  UNWANTED_NAME_PATTERNS: "*.pdb *.ilk *.user *.ncb *.suo *.log *.dmp *.zip imgui.ini desktop.ini dxcompiler.dll dxil.dll"
  UNWANTED_DIR_PATTERNS: "generated x64 win32 arm64 .vs bin ipch logs Dump"

jobs:
  check-files:
    name: 不要なファイルを検索
    runs-on: ubuntu-latest

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4
      
      - name: 不要なファイルとディレクトリを検索(bash)
        run: |
          # ディレクトリ条件の構築
          DIR_CONDITIONS=()
          for pattern in $UNWANTED_DIR_PATTERNS; do
            if [ ${#DIR_CONDITIONS[@]} -gt 0 ]; then DIR_CONDITIONS+=("-o"); fi
            DIR_CONDITIONS+=("-iname" "$pattern")
          done

          # ファイル条件の構築 (UNWANTED_NAME_PATTERNS を使用するように修正)
          NAME_CONDITIONS=()
          for pattern in $UNWANTED_NAME_PATTERNS; do
            if [ ${#NAME_CONDITIONS[@]} -gt 0 ]; then NAME_CONDITIONS+=("-o"); fi
            NAME_CONDITIONS+=("-iname" "$pattern")
          done

          # 検索実行
          # 1. .gitを除外
          # 2. 条件に合うディレクトリを抽出してprune（中身を辿らない）
          # 3. 条件に合うファイルを抽出
          UNWANTED_LIST=$(find . -path "./.git" -prune -o \
            \( \( "${DIR_CONDITIONS[@]}" \) -type d -print -prune \) -o \
            \( \( "${NAME_CONDITIONS[@]}" \) -type f -print \))

          if [ -n "$UNWANTED_LIST" ]; then
            echo "::error::不要なファイルまたはディレクトリが見つかりました！"
            echo "--------------------------------------------------"
            echo "$UNWANTED_LIST"
            echo "--------------------------------------------------"
            echo "これらのファイルはリポジトリに含めないでください。.gitignoreの設定を確認してください。"
            exit 1
          fi

          echo "リポジトリはクリーンです。"